<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digit AI — Live Neural Network</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
:root{--font:'DM Sans',sans-serif;--mono:'JetBrains Mono',monospace;--t:.2s}

[data-theme="light"]{
  --bg:#e9ecf0;--surface:#ffffff;--glass-b:#d0d4dc;--glass-sh:0 1px 6px rgba(0,0,0,.05);
  --inset:#e0e4ea;--border:#c5c9d2;
  --t1:#0b1120;--t2:#4a5468;--t3:#8892a4;
  --ac:#5856f0;--ac-g:linear-gradient(135deg,#5856f0,#7e6df5,#a78bfa);
  --ac-soft:rgba(88,86,240,.09);--ac-glow:rgba(88,86,240,.2);
  --ok:#0c9e6b;--ok-s:rgba(12,158,107,.08);
  --warn:#d49000;--warn-s:rgba(212,144,0,.08);
  --err:#dc3545;--err-s:rgba(220,53,69,.08);
  --bar:#d0d4dc;
  --n-dot:#5856f0;--n-dot-idle:#9ca3b4;
  --conn-default:#c8ccd6;--conn-active:#22c55e;--conn-inactive:#ef4444;
  --chart-g:rgba(0,0,0,.06);
}
[data-theme="dark"]{
  --bg:#070a10;--surface:#0f1219;--glass-b:#252b37;--glass-sh:0 1px 6px rgba(0,0,0,.35);
  --inset:#0a0d15;--border:#2a3040;
  --t1:#e4e9f2;--t2:#8a93a6;--t3:#4e5668;
  --ac:#7274f9;--ac-g:linear-gradient(135deg,#6366f1,#8b7cf8,#c084fc);
  --ac-soft:rgba(99,102,241,.1);--ac-glow:rgba(99,102,241,.22);
  --ok:#34d399;--ok-s:rgba(52,211,153,.08);
  --warn:#fbbf24;--warn-s:rgba(251,191,36,.08);
  --err:#f87171;--err-s:rgba(248,113,113,.08);
  --bar:#1e2430;
  --n-dot:#818cf8;--n-dot-idle:#3e4556;
  --conn-default:#252b37;--conn-active:#22c55e;--conn-inactive:#dc2626;
  --chart-g:rgba(255,255,255,.04);
}

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%}
body{font-family:var(--font);background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;transition:background var(--t),color var(--t);min-height:100%}

/* PAGE — natural flow, compact enough to fit one screen */
.page{max-width:1440px;margin:0 auto;padding:8px 16px 6px}

/* HEADER */
.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-shrink:0}
.logo{display:flex;align-items:center;gap:6px}
.logo-i{width:26px;height:26px;border-radius:6px;background:var(--ac-g);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:.6rem;color:#fff;box-shadow:0 2px 8px var(--ac-glow)}
.logo-t{font-size:1rem;font-weight:700;letter-spacing:-.02em;background:var(--ac-g);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hdr-r{display:flex;align-items:center;gap:8px}
.pill{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:.58rem;font-weight:600}
.pill-ok{background:var(--ok-s);color:var(--ok)}.pill-off{background:var(--err-s);color:var(--err)}.pill-tr{background:var(--warn-s);color:var(--warn)}
.dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:pls 2s ease-in-out infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.3}}
.th{width:34px;height:17px;border-radius:9px;border:1px solid var(--border);background:var(--inset);cursor:pointer;position:relative;transition:background var(--t)}
.th::after{content:'';position:absolute;top:1.5px;left:1.5px;width:12px;height:12px;border-radius:50%;background:var(--ac);transition:transform var(--t);box-shadow:0 1px 3px rgba(0,0,0,.25)}
[data-theme="dark"] .th::after{transform:translateX(17px)}
.th .i{position:absolute;top:1px;font-size:8px;line-height:15px}.th .i.s{left:3px}.th .i.m{right:3px}
.hdr-btn{padding:3px 8px;border-radius:5px;border:1.5px solid var(--border);background:var(--surface);color:var(--err);font-family:var(--font);font-size:.58rem;font-weight:600;cursor:pointer;transition:all var(--t);display:flex;align-items:center;gap:3px}
.hdr-btn:hover{background:var(--err-s);border-color:var(--err)}
.hdr-btn svg{width:10px;height:10px}

/* ================================================================
   MAIN GRID — 4 columns, 2 rows, both rows sized to content
   Col: [left 260px] [network flex] [graphs 200px]
   Row 1 height = network height = 280px
   Row 2 height = remaining
   ================================================================ */
.grid{
  display:grid;
  grid-template-columns:260px 1fr 200px;
  grid-template-rows:280px auto;
  gap:8px;
  margin-top:8px;
}

/* CARD */
.c{background:var(--surface);border:1.5px solid var(--glass-b);border-radius:8px;box-shadow:var(--glass-sh);padding:8px;transition:background var(--t),border-color var(--t);overflow:hidden}
.c-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.c-t{font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--t3)}
.tag{font-family:var(--mono);font-size:.48rem;padding:1px 5px;border-radius:3px;background:var(--ac-soft);color:var(--ac);font-weight:700}

/* ================================================================
   R1C1: DRAW AREA — canvas is square, fills the card width
   ================================================================ */
.draw-cell{grid-row:1;grid-column:1;display:flex;flex-direction:column}
.cvs-w{
  flex:1;min-height:0;
  aspect-ratio:1;
  max-height:calc(280px - 30px); /* card height minus header */
  width:auto;
  align-self:center;
  background:#000;border-radius:6px;border:1.5px solid var(--border);
  overflow:hidden;cursor:crosshair;position:relative;
}
#drawCanvas{width:100%;height:100%;display:block;touch-action:none}
.cvs-w::after{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);
  background-size:calc(100%/28) calc(100%/28)}

/* ================================================================
   R1C2: NEURAL NETWORK — exactly 280px tall
   ================================================================ */
.net-cell{
  grid-row:1;grid-column:2;
  display:flex;flex-direction:column;
  background:var(--surface);border:1.5px solid var(--glass-b);border-radius:8px;box-shadow:var(--glass-sh);
  transition:background var(--t),border-color var(--t);overflow:hidden;
}
.net-top{display:flex;justify-content:space-between;align-items:center;padding:6px 10px 0;flex-shrink:0}
#netCvs{flex:1;width:100%;display:block;min-height:0}
.net-lbl{display:flex;justify-content:space-between;padding:3px 16px 6px;flex-shrink:0;font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--t3)}

/* ================================================================
   R1C3: ACCURACY GRAPH — square, fits in 280px row
   ================================================================ */
.acc-cell{grid-row:1;grid-column:3;display:flex;flex-direction:column}
.ch-wrap{flex:1;min-height:0;display:flex;align-items:center;justify-content:center}
.ch-sq{width:180px;height:180px;position:relative}
.ch-sq canvas{width:100%!important;height:100%!important;display:block}

/* ================================================================
   R2C1: BUTTONS + PREDICTION + SYSTEM
   ================================================================ */
.bot-left{grid-row:2;grid-column:1;display:flex;flex-direction:column;gap:6px}
.btns{display:flex;gap:4px;flex-shrink:0}
.b{flex:1;padding:6px;border:1.5px solid var(--border);border-radius:5px;background:var(--surface);color:var(--t1);font-family:var(--font);font-size:.62rem;font-weight:600;cursor:pointer;transition:all var(--t);display:flex;align-items:center;justify-content:center;gap:3px}
.b:hover{border-color:var(--ac);background:var(--ac-soft)}.b svg{width:10px;height:10px}
.b-a{background:var(--ac);color:#fff;border-color:var(--ac)}.b-a:hover{filter:brightness(1.1)}
.b-d{color:var(--err)}.b-d:hover{background:var(--err-s);border-color:var(--err)}

.pred{display:flex;align-items:center;gap:8px;margin-top:4px}
.pred-d{width:46px;height:46px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:1.6rem;font-weight:700;color:var(--ac);background:var(--ac-soft);border-radius:7px;border:2px solid transparent;transition:all .25s;flex-shrink:0}
.pred-d.on{border-color:var(--ac);box-shadow:0 0 12px var(--ac-glow)}
.pred-i .lb{font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--t3)}
.pred-i .cv{font-family:var(--mono);font-size:1.05rem;font-weight:700}
.pred-i .ms{font-family:var(--mono);font-size:.52rem;color:var(--t3)}

.sts{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:4px}
.st{padding:4px 5px;background:var(--inset);border-radius:4px;border:1.5px solid var(--border)}
.st-l{font-size:.44rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--t3)}
.st-v{font-family:var(--mono);font-size:.7rem;font-weight:700}
.c-ok{color:var(--ok)}.c-ac{color:var(--ac)}.c-w{color:var(--warn)}

.prg{display:none;margin-top:4px}.prg.on{display:block}
.prg-tr{width:100%;height:3px;background:var(--bar);border-radius:2px;overflow:hidden;margin-bottom:2px}
.prg-fl{height:100%;background:var(--ac-g);border-radius:2px;width:0%;transition:width .4s}
.prg-t{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.48rem;color:var(--t3)}

/* ================================================================
   R2C2: CONFIDENCE BARS — fills remaining height
   ================================================================ */
.conf-cell{grid-row:2;grid-column:2;display:flex;flex-direction:column}
.cb{display:flex;flex-direction:column;gap:3px}
.cr{display:flex;align-items:center;gap:5px;height:24px}
.cr-l{font-family:var(--mono);font-size:.6rem;font-weight:700;width:12px;text-align:center;color:var(--t3)}
.cr-tk{flex:1;height:60%;min-height:12px;max-height:22px;background:var(--bar);border-radius:3px;overflow:hidden}
.cr-fl{height:100%;border-radius:3px;background:var(--ac);opacity:.35;width:0%;transition:width .1s,opacity .1s}
.cr-fl.hit{opacity:1;background:var(--ac-g);box-shadow:0 0 6px var(--ac-glow)}
.cr-v{font-family:var(--mono);font-size:.55rem;font-weight:600;width:36px;text-align:right;color:var(--t3);transition:color .1s}
.cr-v.hit{color:var(--ac);font-weight:700}

/* ================================================================
   R2C3: LOSS GRAPH — square
   ================================================================ */
.loss-cell{grid-row:2;grid-column:3;display:flex;flex-direction:column}

/* FOOTER */
.ftr{display:flex;justify-content:space-between;padding:4px 0;font-family:var(--mono);font-size:.48rem;color:var(--t3)}

/* MODALS */
.mo{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.5);backdrop-filter:blur(5px);align-items:center;justify-content:center}
.mo.on{display:flex}
.mo-b{background:var(--surface);border:1.5px solid var(--glass-b);border-radius:10px;padding:18px;max-width:340px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,.4)}
.mo-b h2{font-size:.9rem;font-weight:700;margin-bottom:4px}
.mo-b p{color:var(--t2);font-size:.75rem;margin-bottom:10px}
.sl-g{margin-bottom:10px}
.sl-g label{display:flex;justify-content:space-between;font-size:.7rem;font-weight:500;margin-bottom:4px}
.sl-g label span{font-family:var(--mono);color:var(--ac)}
input[type=range]{width:100%;height:3px;-webkit-appearance:none;background:var(--bar);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--ac);cursor:pointer;box-shadow:0 0 5px var(--ac-glow)}
.mo-btn{display:flex;gap:6px}.mo-btn .b{flex:1;padding:6px}

@media(max-width:900px){.grid{grid-template-columns:1fr;grid-template-rows:repeat(6,auto)}.draw-cell,.net-cell,.acc-cell,.bot-left,.conf-cell,.loss-cell{grid-row:auto;grid-column:1}html,body{overflow:auto}}
</style>
</head>
<body>
<div class="page">
<header class="hdr">
  <div class="logo"><div class="logo-i">AI</div><span class="logo-t">Digit AI</span></div>
  <div class="hdr-r">
    <div class="pill pill-ok" id="sPill"><span class="dot"></span><span id="sTxt">Connecting</span></div>
    <button class="th" id="thBtn" title="Toggle theme"><span class="i s">☀</span><span class="i m">☾</span></button>
    <button class="hdr-btn" id="btnOff"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>Close</button>
  </div>
</header>
<div class="grid">

  <!-- R1C1: Draw -->
  <div class="c draw-cell">
    <div class="c-h"><span class="c-t">Draw</span><span class="tag">28×28</span></div>
    <div class="cvs-w"><canvas id="drawCanvas"></canvas></div>
  </div>

  <!-- R1C2: Network -->
  <div class="net-cell" id="netCard">
    <div class="net-top"><span class="c-t">Neural Network Diagram</span><span class="tag">CNN</span></div>
    <canvas id="netCvs"></canvas>
    <div class="net-lbl"><span>Input</span><span>Conv1</span><span>Conv2</span><span>Dense</span><span>Output 0–9</span></div>
  </div>

  <!-- R1C3: Accuracy -->
  <div class="c acc-cell">
    <div class="c-h"><span class="c-t">Accuracy</span><span class="tag" id="epTag">0 ep</span></div>
    <div class="ch-wrap"><div class="ch-sq"><canvas id="chAcc"></canvas></div></div>
  </div>

  <!-- R2C1: Buttons + Prediction + System -->
  <div class="bot-left">
    <div class="btns">
      <button class="b" id="btnCl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a1 1 0 011-1h6a1 1 0 011 1v2m2 0v12a2 2 0 01-2 2H8a2 2 0 01-2-2V6h12z"/></svg>Clear</button>
      <button class="b b-a" id="btnTr"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>Train</button>
      <button class="b b-d" id="btnRs"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/></svg>Reset</button>
    </div>
    <div class="c">
      <div class="c-h"><span class="c-t">Prediction</span><span class="tag" id="mSt">No Model</span></div>
      <div class="pred">
        <div class="pred-d" id="pDig">—</div>
        <div class="pred-i"><div class="lb">Confidence</div><div class="cv" id="pConf">0.0%</div><div class="ms" id="pMs">—</div></div>
      </div>
      <div class="sts">
        <div class="st"><div class="st-l">Accuracy</div><div class="st-v c-ok" id="sAcc">—</div></div>
        <div class="st"><div class="st-l">Inference</div><div class="st-v c-ac" id="sInf">—</div></div>
        <div class="st"><div class="st-l">Loss</div><div class="st-v c-w" id="sLoss">—</div></div>
        <div class="st"><div class="st-l">Device</div><div class="st-v" id="sDev">—</div></div>
      </div>
      <div class="prg" id="prg"><div class="prg-tr"><div class="prg-fl" id="prgFl"></div></div><div class="prg-t"><span id="prgEp">Epoch 0/0</span><span id="prgAc">0%</span></div></div>
    </div>
  </div>

  <!-- R2C2: Confidence -->
  <div class="c conf-cell">
    <div class="c-h"><span class="c-t">Confidence</span><span class="tag">Real-Time</span></div>
    <div class="cb" id="cBars"></div>
  </div>

  <!-- R2C3: Loss -->
  <div class="c loss-cell">
    <div class="c-h"><span class="c-t">Loss</span></div>
    <div class="ch-wrap"><div class="ch-sq"><canvas id="chLoss"></canvas></div></div>
  </div>

</div>
<div class="ftr"><span id="fSt">Connecting...</span><span id="fFps">— FPS</span></div>
</div>

<div class="mo" id="mTrain"><div class="mo-b"><h2>Train Neural Network</h2><p>Downloads MNIST (~12 MB first run). ~3–5 min on GPU.</p><div class="sl-g"><label>Epochs <span id="epCnt">15</span></label><input type="range" id="epSl" min="5" max="30" value="15"></div><div class="mo-btn"><button class="b" id="mCancel">Cancel</button><button class="b b-a" id="mStart">Start</button></div></div></div>
<div class="mo" id="mShut"><div class="mo-b"><h2>Close Project?</h2><p>Shuts down the server. Run <code style="font-family:var(--mono);background:var(--inset);padding:.1em .25em;border-radius:3px;font-size:.8em">python run_backend.py</code> to restart.</p><div class="mo-btn"><button class="b" id="mShutNo">Cancel</button><button class="b" id="mShutYes" style="background:var(--err);color:#fff;border-color:var(--err)">Shut Down</button></div></div></div>

<script>
const $=id=>document.getElementById(id);
const dpr=window.devicePixelRatio||1;
function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}

document.documentElement.setAttribute('data-theme',localStorage.getItem('dai-th')||'dark');
$('thBtn').onclick=()=>{const n=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',n);localStorage.setItem('dai-th',n);netIdle();renderCharts()};

const cb=$('cBars');for(let i=0;i<10;i++)cb.innerHTML+=`<div class="cr"><span class="cr-l">${i}</span><div class="cr-tk"><div class="cr-fl" id="b${i}"></div></div><span class="cr-v" id="v${i}">0%</span></div>`;

/* DRAW — canvas size matches the wrapper dynamically */
const dc=$('drawCanvas'),dx=dc.getContext('2d');
let isDr=false,hasCt=false,lx,ly,cvsSz=200;
function initDr(){
  const r=dc.parentElement.getBoundingClientRect();
  cvsSz=Math.round(Math.min(r.width,r.height));
  dc.width=cvsSz;dc.height=cvsSz;
  dx.lineCap='round';dx.lineJoin='round';clrCvs();
}
function clrCvs(){dx.fillStyle='#000';dx.fillRect(0,0,cvsSz,cvsSz);hasCt=false;updPred(null)}
function gP(e){const r=dc.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:(t.clientX-r.left)*(cvsSz/r.width),y:(t.clientY-r.top)*(cvsSz/r.height)}}
function sD(e){e.preventDefault();isDr=true;const p=gP(e);lx=p.x;ly=p.y}
function mD(e){if(!isDr)return;e.preventDefault();const p=gP(e);dx.strokeStyle='#fff';dx.lineWidth=cvsSz/14;dx.beginPath();dx.moveTo(lx,ly);dx.lineTo(p.x,p.y);dx.stroke();lx=p.x;ly=p.y;hasCt=true;reqPred()}
function eD(){isDr=false;if(hasCt)reqPred()}
dc.addEventListener('mousedown',sD);dc.addEventListener('mousemove',mD);dc.addEventListener('mouseup',eD);dc.addEventListener('mouseleave',eD);
dc.addEventListener('touchstart',sD,{passive:false});dc.addEventListener('touchmove',mD,{passive:false});dc.addEventListener('touchend',eD);

function getPx(){
  const sd=dx.getImageData(0,0,cvsSz,cvsSz);let x0=cvsSz,y0=cvsSz,x1=0,y1=0,f=false;
  for(let y=0;y<cvsSz;y++)for(let x=0;x<cvsSz;x++){const i=(y*cvsSz+x)*4,b=.299*sd.data[i]+.587*sd.data[i+1]+.114*sd.data[i+2];if(b>30){if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y;f=true}}
  if(!f)return Array(784).fill(0);
  const cw=x1-x0+1,ch=y1-y0+1,t=document.createElement('canvas');t.width=28;t.height=28;
  const tc=t.getContext('2d');tc.fillStyle='#000';tc.fillRect(0,0,28,28);
  const s=Math.min(20/cw,20/ch),dw=cw*s,dh=ch*s;tc.imageSmoothingEnabled=true;tc.imageSmoothingQuality='high';
  tc.drawImage(dc,x0,y0,cw,ch,(28-dw)/2,(28-dh)/2,dw,dh);
  const id=tc.getImageData(0,0,28,28),px=new Float32Array(784);
  for(let i=0;i<784;i++)px[i]=.299*id.data[i*4]+.587*id.data[i*4+1]+.114*id.data[i*4+2];
  return Array.from(px);
}

/* WS */
let ws,wsOk=false,pend=false,lpT=0,lastPD=null;
function connWS(){const p=location.protocol==='https:'?'wss:':'ws:';ws=new WebSocket(`${p}//${location.host}/ws`);
  ws.onopen=()=>{wsOk=true;setSt('ok','Live');$('fSt').textContent='Live inference running'};
  ws.onmessage=e=>onMsg(JSON.parse(e.data));ws.onclose=()=>{wsOk=false;setSt('off','Offline');setTimeout(connWS,2000)};ws.onerror=()=>{wsOk=false}}
function setSt(t,s){$('sPill').className='pill '+(t==='ok'?'pill-ok':t==='off'?'pill-off':'pill-tr');$('sTxt').textContent=s}
function reqPred(){if(!wsOk||!hasCt||pend||Date.now()-lpT<50)return;lpT=Date.now();pend=true;ws.send(JSON.stringify({type:'predict',data:{pixels:getPx()}}))}

function onMsg(m){switch(m.type){
  case'init':
    if(m.data.model_loaded)$('mSt').textContent='Ready';
    $('sDev').textContent=m.data.device||'—';
    if(m.data.training_history&&m.data.training_history.accuracy&&m.data.training_history.accuracy.length>0){
      tD=m.data.training_history;
      // Ensure arrays exist
      if(!tD.train_loss)tD.train_loss=[];if(!tD.test_loss)tD.test_loss=[];
      renderCharts();
      $('sAcc').textContent=tD.accuracy[tD.accuracy.length-1]+'%';
      $('epTag').textContent=tD.accuracy.length+' ep';
      if(tD.train_loss.length)$('sLoss').textContent=tD.train_loss[tD.train_loss.length-1].toFixed(4);
    }break;
  case'prediction':pend=false;if(!m.data.error){lastPD=m.data;updPred(m.data);drawNet(m.data.activations,m.data.probabilities,m.data.digit);updFps(m.data.inference_ms)}break;
  case'training_started':setSt('tr','Training');$('prg').classList.add('on');$('mSt').textContent='Training';break;
  case'training_complete':setSt('ok','Live');$('prg').classList.remove('on');$('mSt').textContent='Ready';if(m.data.history){tD=m.data.history;renderCharts();$('sAcc').textContent=m.data.accuracy+'%';$('epTag').textContent=m.data.epochs+' ep'}break;
  case'training_update':updTr(m.data);break;
  case'model_reset':$('mSt').textContent='No Model';tD={train_loss:[],test_loss:[],accuracy:[]};renderCharts();clrCvs();lastPD=null;netIdle();break;
  case'shutdown_ack':document.body.innerHTML='<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:DM Sans;color:#777;font-size:1rem;flex-direction:column;gap:6px"><span style="font-size:1.8rem">✓</span>Server shut down<br><span style="font-size:.75rem;color:#999">Close this tab</span></div>';break;
}}

let fpsH=[];
function updFps(ms){fpsH.push(ms);if(fpsH.length>30)fpsH.shift();const a=fpsH.reduce((s,v)=>s+v,0)/fpsH.length;$('fFps').textContent=Math.round(1000/a)+' FPS';$('sInf').textContent=a.toFixed(1)+' ms'}
function updPred(d){if(!d){$('pDig').textContent='—';$('pDig').classList.remove('on');$('pConf').textContent='0.0%';$('pMs').textContent='—';for(let i=0;i<10;i++){$('b'+i).style.width='0%';$('b'+i).className='cr-fl';$('v'+i).textContent='0%';$('v'+i).className='cr-v'}return}
  $('pDig').textContent=d.digit;$('pDig').classList.add('on');$('pConf').textContent=d.confidence+'%';$('pMs').textContent=d.inference_ms+' ms';
  for(let i=0;i<10;i++){const p=d.probabilities[i];$('b'+i).style.width=p+'%';$('v'+i).textContent=p.toFixed(1)+'%';$('b'+i).className=i===d.digit?'cr-fl hit':'cr-fl';$('v'+i).className=i===d.digit?'cr-v hit':'cr-v'}}
function updTr(d){$('prgFl').style.width=(d.epoch/d.total_epochs*100)+'%';$('prgEp').textContent=`Epoch ${d.epoch}/${d.total_epochs}`;$('prgAc').textContent=d.accuracy+'%';$('sAcc').textContent=d.accuracy+'%';$('sLoss').textContent=d.test_loss.toFixed(4);tD.accuracy.push(d.accuracy);tD.train_loss.push(d.train_loss);tD.test_loss.push(d.test_loss);renderCharts();$('epTag').textContent=d.epoch+' ep'}

/* ================================================================
   NEURAL NETWORK VIZ
   - Idle: all dots grey, all lines grey (default color)
   - Active: dots one color, lines green (predicted path) / red (others)
   - Reset → back to idle
   ================================================================ */
const nc=$('netCvs'),nx=nc.getContext('2d');
const LY=[{n:14},{n:10},{n:12},{n:12},{n:10}];

function resN(){
  const box=nc.parentElement.getBoundingClientRect();
  // Use actual available space, minus header and labels
  const w=box.width,h=box.height;
  nc.width=w*dpr;nc.height=h*dpr;
  nx.setTransform(dpr,0,0,dpr,0,0);
  nc.style.width=w+'px';nc.style.height=h+'px';
}
function nPos(w,h){
  const px=30,gx=(w-px*2)/(LY.length-1),out=[];
  for(let l=0;l<LY.length;l++){const x=px+l*gx,n=LY[l].n,gap=Math.min(16,(h-16)/(n+1)),sy=(h-(n-1)*gap)/2,a=[];for(let i=0;i<n;i++)a.push({x,y:sy+i*gap});out.push(a)}return out;
}

function netIdle(){
  resN();const w=nc.width/dpr,h=nc.height/dpr,pos=nPos(w,h);
  const dotC=css('--n-dot-idle'),lineC=css('--conn-default');
  nx.clearRect(0,0,w,h);
  for(let l=0;l<pos.length-1;l++){const step=Math.max(1,Math.floor(pos[l].length*pos[l+1].length/80));let c=0;
    for(let i=0;i<pos[l].length;i++)for(let j=0;j<pos[l+1].length;j++){if(c++%step)continue;
      nx.beginPath();nx.moveTo(pos[l][i].x,pos[l][i].y);nx.lineTo(pos[l+1][j].x,pos[l+1][j].y);
      nx.strokeStyle=lineC;nx.lineWidth=.5;nx.stroke()}}
  for(const L of pos)for(const n of L){nx.beginPath();nx.arc(n.x,n.y,3.5,0,Math.PI*2);nx.fillStyle=dotC;nx.fill()}
}

function drawNet(acts,probs,pred){
  if(!acts||!Object.keys(acts).length)return netIdle();
  resN();const w=nc.width/dpr,h=nc.height/dpr,pos=nPos(w,h);
  const dotC=css('--n-dot');
  const GREEN='#22c55e';  // always green, not from CSS
  const RED='#ef4444';    // always red
  const GREY=css('--n-dot-idle');

  const A=[Array(LY[0].n).fill(.3),(acts.conv1||[]).slice(0,LY[1].n),(acts.conv2||[]).slice(0,LY[2].n),(acts.fc1||[]).slice(0,LY[3].n),(probs||[]).map(p=>p/100)];
  for(let l=0;l<A.length;l++)while(A[l].length<LY[l].n)A[l].push(0);
  nx.clearRect(0,0,w,h);

  // Build "predicted path" — trace back from predicted output
  // Output: only pred neuron. Each prior layer: top N active neurons.
  const pathNeurons=[];
  for(let l=0;l<LY.length;l++)pathNeurons.push(new Set());
  pathNeurons[LY.length-1].add(pred);
  // For each hidden layer, mark the top 4 most active neurons as "on path"
  for(let l=LY.length-2;l>=0;l--){
    const sorted=[...A[l].map((v,i)=>({v,i}))].sort((a,b)=>b.v-a.v);
    const topN=Math.min(4,sorted.length);
    for(let k=0;k<topN;k++){if(sorted[k].v>0.15)pathNeurons[l].add(sorted[k].i)}
  }

  // DRAW CONNECTIONS — red first (background), then green on top
  // Red (non-predicted) connections
  for(let l=0;l<pos.length-1;l++){
    for(let i=0;i<pos[l].length;i++){
      for(let j=0;j<pos[l+1].length;j++){
        const str=(A[l][i]+A[l+1][j])/2;
        if(str<0.03)continue;
        const srcOn=pathNeurons[l].has(i),dstOn=pathNeurons[l+1].has(j);
        if(srcOn&&dstOn)continue; // skip green ones, draw later
        nx.beginPath();nx.moveTo(pos[l][i].x,pos[l][i].y);nx.lineTo(pos[l+1][j].x,pos[l+1][j].y);
        nx.strokeStyle=RED;nx.globalAlpha=0.05+Math.min(str,0.5)*0.15;nx.lineWidth=0.4;nx.stroke();
        nx.globalAlpha=1;
      }
    }
  }
  // Green (predicted path) connections — drawn on top
  for(let l=0;l<pos.length-1;l++){
    for(let i=0;i<pos[l].length;i++){
      for(let j=0;j<pos[l+1].length;j++){
        const str=(A[l][i]+A[l+1][j])/2;
        if(str<0.03)continue;
        const srcOn=pathNeurons[l].has(i),dstOn=pathNeurons[l+1].has(j);
        if(!srcOn||!dstOn)continue;
        nx.beginPath();nx.moveTo(pos[l][i].x,pos[l][i].y);nx.lineTo(pos[l+1][j].x,pos[l+1][j].y);
        nx.strokeStyle=GREEN;nx.globalAlpha=0.3+str*0.6;nx.lineWidth=0.8+str*2;nx.stroke();
        nx.globalAlpha=1;
      }
    }
  }

  // DOTS — all same color (purple/blue), size by activation
  for(let l=0;l<pos.length;l++){
    for(let i=0;i<pos[l].length;i++){
      const nd=pos[l][i],a=A[l][i]||0,r=3+a*3;
      nx.beginPath();nx.arc(nd.x,nd.y,r,0,Math.PI*2);
      nx.fillStyle=dotC;nx.globalAlpha=0.3+a*0.7;nx.fill();nx.globalAlpha=1;

      // Output labels
      if(l===pos.length-1){
        const ip=i===pred;
        nx.font=`${ip?700:600} ${ip?11:8}px "JetBrains Mono"`;
        nx.fillStyle=ip?GREEN:css('--t3');nx.textAlign='left';
        nx.fillText(i+'',nd.x+r+4,nd.y+3);
        if(ip){
          // Green ring around predicted
          nx.beginPath();nx.arc(nd.x,nd.y,r+3,0,Math.PI*2);
          nx.strokeStyle=GREEN;nx.lineWidth=2;nx.stroke();
          nx.font='700 9px "JetBrains Mono"';nx.fillStyle=GREEN;
          nx.fillText(probs[i].toFixed(0)+'%',nd.x+r+16,nd.y+3);
        }
      }
    }
  }
}

/* CHARTS — rendered into fixed 180×180 squares */
let tD={train_loss:[],test_loss:[],accuracy:[]};
function renderCharts(){rCh('chAcc',tD.accuracy||[],{color:css('--ok'),minY:90,maxY:100,sfx:'%'});rCh('chLoss',tD.train_loss||[],{color:css('--warn'),minY:0,maxY:null,sfx:''})}
function rCh(id,data,o){
  const cv=$(id),ct=cv.getContext('2d'),r=cv.parentElement.getBoundingClientRect();
  const sz=Math.min(r.width,r.height);
  cv.width=sz*dpr;cv.height=sz*dpr;ct.setTransform(dpr,0,0,dpr,0,0);cv.style.width=sz+'px';cv.style.height=sz+'px';
  const w=sz,h=sz,pd={t:8,r:8,b:16,l:32},cW=w-pd.l-pd.r,cH=h-pd.t-pd.b;
  ct.clearRect(0,0,w,h);const tc=css('--t3'),gc=css('--chart-g');
  if(!data.length){ct.font='500 9px "DM Sans"';ct.fillStyle=tc;ct.textAlign='center';ct.fillText('Train to see data',w/2,h/2);return}
  const mn=o.minY??Math.min(...data)*.95,mx=o.maxY??Math.max(...data)*1.05,rn=mx-mn||1;
  ct.strokeStyle=gc;ct.lineWidth=1;
  for(let i=0;i<=4;i++){const y=pd.t+cH/4*i;ct.beginPath();ct.moveTo(pd.l,y);ct.lineTo(w-pd.r,y);ct.stroke();const v=mx-(rn/4)*i;ct.font='500 7px "JetBrains Mono"';ct.fillStyle=tc;ct.textAlign='right';ct.fillText(v.toFixed(v>10?1:3)+o.sfx,pd.l-4,y+3)}
  const sx=data.length>1?cW/(data.length-1):0;ct.beginPath();
  for(let i=0;i<data.length;i++){const x=pd.l+i*sx,y=pd.t+cH-((data[i]-mn)/rn)*cH;i===0?ct.moveTo(x,y):ct.lineTo(x,y)}
  ct.strokeStyle=o.color;ct.lineWidth=2;ct.lineJoin='round';ct.stroke();
  ct.lineTo(pd.l+(data.length-1)*sx,pd.t+cH);ct.lineTo(pd.l,pd.t+cH);ct.closePath();
  const gd=ct.createLinearGradient(0,pd.t,0,pd.t+cH);gd.addColorStop(0,o.color+'25');gd.addColorStop(1,o.color+'04');ct.fillStyle=gd;ct.fill();
  for(let i=0;i<data.length;i++){const x=pd.l+i*sx,y=pd.t+cH-((data[i]-mn)/rn)*cH;ct.beginPath();ct.arc(x,y,2.5,0,Math.PI*2);ct.fillStyle=o.color;ct.fill()}}

/* BUTTONS */
$('btnCl').onclick=()=>{clrCvs();lastPD=null;netIdle()};
$('btnTr').onclick=()=>$('mTrain').classList.add('on');
$('mCancel').onclick=()=>$('mTrain').classList.remove('on');
$('epSl').oninput=e=>$('epCnt').textContent=e.target.value;
$('mStart').onclick=()=>{const ep=+$('epSl').value;$('mTrain').classList.remove('on');tD={train_loss:[],test_loss:[],accuracy:[]};ws.send(JSON.stringify({type:'train',data:{epochs:ep}}))};
$('btnRs').onclick=()=>{if(confirm('Reset model?'))ws.send(JSON.stringify({type:'reset_model'}))};
$('btnOff').onclick=()=>$('mShut').classList.add('on');
$('mShutNo').onclick=()=>$('mShut').classList.remove('on');
$('mShutYes').onclick=()=>{$('mShut').classList.remove('on');if(wsOk)ws.send(JSON.stringify({type:'shutdown'}));fetch('/api/shutdown',{method:'POST'}).catch(()=>{});document.body.innerHTML='<div style="display:flex;height:100vh;align-items:center;justify-content:center;font-family:DM Sans,sans-serif;color:#777;font-size:1rem;flex-direction:column;gap:6px"><span style="font-size:1.8rem">✓</span>Server shut down<br><span style="font-size:.75rem;color:#999">Close this tab</span></div>'};

setInterval(()=>{if(wsOk)ws.send(JSON.stringify({type:'ping'}))},15000);
window.addEventListener('resize',()=>{initDr();netIdle();renderCharts()});
initDr();netIdle();renderCharts();connWS();
</script>
</body>
</html>